using UnityEngine;
using UnityEngine.UI;
using UnityEngine.Events;
using System.Collections.Generic;
using System;
using BAStoryPlayer.DoTweenS;
using BAStoryPlayer.UI;
using BAStoryPlayer.Event;
using Timer = BAStoryPlayer.Utility.Timer;

namespace BAStoryPlayer
{
    public class BAStoryPlayer : MonoBehaviour
    {
        private bool isAuto = false;
        [Space]
        private int groupID = -1;

        [Header("References")]
        [SerializeField] private Image imageBackground;
        [Space]
        [SerializeField] private CharacterManager characterModule;
        [SerializeField] private UIManager uiModule;
        [SerializeField] private AudioManager audioModule;

        private List<StoryUnit> storyUnit;
        [Header("Real-Time Data")]
        [SerializeField] private int currentUnitIndex = 0;
        private Queue<int> priorUnitIndexes = new Queue<int>(); // 优先下标队列 
        [SerializeField] private float lockTime = 0;

        [SerializeField] private bool isPlaying = false;
        [SerializeField] private bool isExecutable = true;
        [SerializeField] private bool isLocking = false;

        private Coroutine coroutine_Lock;

        public bool IsAuto
        {
            set
            {
                isAuto = value;
                if (!isAuto)
                {
                    EventBus<OnPlayerCanceledAuto>.Raise();
                    EventBus<OnUnlockedPlayerInput>.ClearCallback();
                }
                if (isAuto && isPlaying && isExecutable) // 文本输出完毕后的状态
                {
                    if (!IsLocking)
                        Next();
                    else
                        EventBus<OnUnlockedPlayerInput>.AddCallback(() =>
                        {
                            Timer.Delay(() =>
                            {
                                ReadyToNext();
                                EventBus<OnUnlockedPlayerInput>.ClearCallback();
                            }, 1);
                        });
                }
            }
            get
            {
                return isAuto;
            }
        }
        public bool IsLocking
        {
            set
            {
                isLocking = value;
                if (isLocking == false)
                    EventBus<OnUnlockedPlayerInput>.Raise();
            }
            get
            {
                return isLocking;
            }
        }

        public CharacterManager CharacterModule
        {
            get
            {
                if (characterModule == null)
                    characterModule = transform.GetComponentInChildren<CharacterManager>();
                return characterModule;
            }
        }
        public UIManager UIModule
        {
            get
            {
                if (uiModule == null)
                    uiModule = transform.GetComponentInChildren<UIManager>();
                return uiModule;
            }
        }
        public AudioManager AudioModule
        {
            get
            {
                if (audioModule == null)
                    audioModule = transform.GetComponent<AudioManager>();
                if (audioModule == null)
                    audioModule = gameObject.AddComponent<AudioManager>();
                return audioModule;
            }
        }

        public GameObject CanvasObject
        {
            get
            {
                Transform current = transform;
                while(current.parent != null)
                    current = transform.parent;
                return current.gameObject;
            }
        }
        public RectTransform CanvasRect => CanvasObject.GetComponent<RectTransform>();

        public int GroupID => groupID;
        public float Volume_Music
        {
            set
            {
                AudioModule.Volume_Music = value;
            }
            get
            {
                return AudioModule.Volume_Music;
            }
        }
        public float Volume_Sound
        {
            set
            {
                AudioModule.Volume_Sound = value;
            }
            get
            {
                return AudioModule.Volume_Sound;
            }
        }
        public float Volume_Master
        {
            set
            {
                AudioModule.Volume_Master = value;
            }
            get
            {
                return AudioModule.Volume_Master;
            }
        }

        void Start()
        {
            if (imageBackground == null)
                imageBackground = transform.Find("Background").GetComponent<Image>();

            // 动作以及表情事件订阅 锁定一定时间的操作
            EventBus<OnAnimatedCharacter>.Binding.Add((data) =>
            {
                Lock(data.time, BAStoryPlayerController.Instance.Setting.Time_Lock_AfterAction);
            });
            // 选项事件订阅
            EventBus<OnPlayerSelectedBranch>.Binding.Add((data) =>
            {
                // 坐标前移寻找最近的选项下标 并放入优先下标队列 遇到0则停止
                for (int i = currentUnitIndex; i < storyUnit.Count; i++)
                {
                    if (storyUnit[i].selectionGroup == data.selectionGroup)
                    {
                        priorUnitIndexes.Enqueue(i);
                    }
                    else if (storyUnit[i].selectionGroup == 0) // 注意添加最后一个无选项组的单元
                    {
                        priorUnitIndexes.Enqueue(i);
                        break;
                    }
                }
                // 注意先切换下标
                NextIndex();
            });
            // 文本输出结束时间订阅 锁定操作一段时间
            EventBus<OnPrintedLine>.Binding.Add(() =>
            {
                Lock(BAStoryPlayerController.Instance.Setting.Time_Lock_AfterPrinting);
            });
        }

        /// <summary>
        /// 设置背景 并优先适应宽度
        /// </summary>
        /// <param name="url">相对URL</param>
        /// <param name="type">背景切换方式 首次无效</param>
        public void SetBackground(string url = null, TransistionType transition = TransistionType.Instant)
        {
            if (url == null)
            {
                switch (transition)
                {
                    case TransistionType.Instant:
                        imageBackground.sprite = null;
                        imageBackground.enabled = false;
                        break;
                    case TransistionType.Smooth:
                        imageBackground.DoColor(Color.black, BAStoryPlayerController.Instance.Setting.Time_SwitchBackground).onComplete = () =>
                         {
                             imageBackground.sprite = null;
                             imageBackground.enabled = false;
                         };
                        break;
                }
                return;
            }

            Sprite sprite = Resources.Load<Sprite>(BAStoryPlayerController.Instance.Setting.Path_Background + url);
            Vector2 size = sprite.rect.size;
            float ratio = size.y / size.x;
            size.x = CanvasRect.rect.width;
            size.y = size.x * ratio;

            imageBackground.GetComponent<RectTransform>().sizeDelta = size;
            if (!imageBackground.enabled)
            {
                imageBackground.enabled = true;
                imageBackground.sprite = sprite;
                imageBackground.color = Color.white;
            }
            else
            {
                switch (transition)
                {
                    case TransistionType.Instant:
                        {
                            imageBackground.sprite = sprite;
                            break;
                        }
                    case TransistionType.Smooth:
                        {
                            imageBackground.DoColor(Color.black, BAStoryPlayerController.Instance.Setting.Time_SwitchBackground / 2).onComplete = () =>
                            {
                                imageBackground.sprite = sprite;
                                imageBackground.DoColor(Color.white, BAStoryPlayerController.Instance.Setting.Time_SwitchBackground / 2);
                            };
                            break;
                        }
                    default: return;
                }
            }
        }

        /// <summary>
        /// 载入执行单元 数据初始化
        /// </summary>
        public void LoadUnits(int groupID, List<StoryUnit> units)
        {
            priorUnitIndexes.Clear();
            this.groupID = groupID;
            storyUnit = units;
            currentUnitIndex = 0;
            IsLocking = false;
            isPlaying = true;
            isExecutable = true;
        }

        /// <summary>
        /// 执行下一单元
        /// </summary>
        public void Next(bool breakLock = false)
        {
            // 文本跳过
            if (isPlaying && UIModule.IsPrinting && !isExecutable)
            {
                UIModule.Skip();
                if (IsAuto)
                    IsAuto = false;
                return;
            }

            // 操作锁 针对非Auto模式
            if (IsLocking && !IsAuto && !breakLock)
                return;

            if (!isExecutable || !isPlaying)
                return;

            if (currentUnitIndex == storyUnit.Count)
            {
                CloseStoryPlayer();
                return;
            }

            // 每一个单元刷新一次锁定时间
            ReflashLockTime();

            switch (storyUnit[currentUnitIndex].type)
            {
                case UnitType.Text:
                case UnitType.Title:
                case UnitType.Option:
                    {
                        storyUnit[currentUnitIndex].Execute();
                        NextIndex();
                        isExecutable = false;
                        break;
                    }
                case UnitType.Command:
                    {
                        if (storyUnit[currentUnitIndex].wait != 0)
                        {
                            // 根据单元等待时间执行等待完毕后自动执行下一单元
                            storyUnit[currentUnitIndex].Execute();
                            isExecutable = false;
                            Timer.Delay(() =>
                           {
                               isExecutable = true;
                               NextIndex();
                               Next(true);
                           }, storyUnit[currentUnitIndex].wait / 1000f);
                            break;
                        }
                        else
                        {
                            storyUnit[currentUnitIndex].Execute();
                            NextIndex();
                            Next(true);
                            break;
                        }

                    }
                default: return;
            }
        }

        /// <summary>
        /// 加载下一个下标
        /// </summary>
        void NextIndex()
        {
            if (priorUnitIndexes.Count != 0)
            {
                currentUnitIndex = priorUnitIndexes.Dequeue();
            }
            else
                currentUnitIndex++;
        }

        /// <summary>
        /// 准备执行下一单元
        /// </summary>
        /// <param name="next">是否直接执行下一单元</param>
        public void ReadyToNext(bool next = false)
        {
            isExecutable = true;
            // 若Auto则直接执行
            if (next || IsAuto)
                Next();
        }

        /// <summary>
        /// 关闭播放器
        /// </summary>
        /// <param name="fadeOut">是否启用幕布渐出</param>
        /// <param name="destoryObject">是否删除播放器Object</param>
        public void CloseStoryPlayer(bool fadeOut = true, bool destoryObject = false)
        {
            isPlaying = false;
            AudioModule.PauseBGM();

            Timer.Delay(() =>
           {
               if (fadeOut)
               {
                   RequireBackdrop(BackdropType.Out, 1, () =>
                   {
                       EventBus<OnClosedStoryPlayer>.Raise();
                       EmotionFactory.ClearCache();
                       if (!destoryObject)
                       {
                           gameObject.SetActive(false);
                           SetBackground();
                           UIModule.HideAllUI();
                           CharacterModule.ClearAllObject();
                           DoTweenS.DoTweenS.KillAll();
                           AudioModule.ClearAll();
                       }
                       else
                       {
                           Destroy(gameObject);
                       }
                   });
               }
               else
               {
                   EventBus<OnClosedStoryPlayer>.Raise();
                   EmotionFactory.ClearCache();
                   if (!destoryObject)
                   {
                       gameObject.SetActive(false);
                       SetBackground();
                       UIModule.HideAllUI();
                       CharacterModule.ClearAllObject();
                       DoTweenS.DoTweenS.KillAll();
                       AudioModule.ClearAll();
                   }
                   else
                   {
                       Destroy(gameObject);
                   }
               }
           }, 2f);
        }
        public void CloseStoryPlayer() => CloseStoryPlayer(true, false);

        public enum BackdropType
        {
            In,
            Out,
            OutIn,
            InOut
        }
        /// <summary>
        /// 创建幕布
        /// </summary>
        /// <param name="type">幕布类型</param>
        /// <param name="duration">持续时间</param>
        /// <param name="feedback">回调函数</param>
        public void RequireBackdrop(BackdropType type,float duration,Action feedback = null)
        {
            GameObject backdrop = new GameObject("Backdrop");
            backdrop.transform.SetParent(transform);
            backdrop.transform.localPosition = Vector3.zero;
            backdrop.transform.localScale = Vector3.one;
            backdrop.AddComponent<RectTransform>().anchorMin = Vector2.zero;
            backdrop.GetComponent<RectTransform>().anchorMax = Vector2.one;
            backdrop.GetComponent<RectTransform>().sizeDelta = backdrop.GetComponent<RectTransform>().anchoredPosition = Vector2.zero;
            var image = backdrop.AddComponent<Image>();

            switch (type)
            {
                case BackdropType.In:
                    {
                        image.color = new Color(0, 0, 0, 1);
                        image.DoAlpha(0, duration).onComplete = ()=> { feedback?.Invoke(); Destroy(backdrop); };
                        break;
                    }
                case BackdropType.Out:
                    {
                        image.color = new Color(0, 0, 0, 0);
                        image.DoAlpha(1, duration).onComplete = () => { feedback?.Invoke(); Destroy(backdrop); };
                        break;
                    }
                case BackdropType.OutIn:
                    {
                        image.color = new Color(0, 0, 0, 0);
                        image.DoAlpha(1, duration/2).onComplete = () => { feedback?.Invoke(); image.DoAlpha(0, duration/2).onComplete = ()=> { Destroy(backdrop); }; };
                        break;
                    }
                case BackdropType.InOut:
                    {
                        image.color = new Color(0, 0, 0, 1);
                        image.DoAlpha(0, duration/2).onComplete = () => { feedback?.Invoke(); image.DoAlpha(1, duration/2).onComplete = ()=> { Destroy(backdrop); }; };
                        break;
                    }
                default:return;

            }
        }

        /// <summary>
        /// 锁定操作一段时间 用于确保动作播放完毕
        /// </summary>
        public void Lock(float duration,float extra = 0.2f)
        {
            if (duration + extra > lockTime)
                ReflashLockTime(duration + extra);
            else
                return;

            if (IsLocking)
                StopCoroutine(coroutine_Lock);

            IsLocking = true;
            coroutine_Lock = Timer.Delay(transform,() =>
            {
                IsLocking = false;
            }, duration + extra);
        }

        /// <summary>
        /// 刷新当前单元锁定事件
        /// </summary>
        /// <param name="value"></param>
        public void ReflashLockTime(float value = 0)
        {
            lockTime = value;
        }
    }
}
